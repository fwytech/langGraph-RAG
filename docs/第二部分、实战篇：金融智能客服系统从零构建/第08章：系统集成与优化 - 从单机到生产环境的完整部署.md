# ç¬¬08ç« ï¼šç³»ç»Ÿé›†æˆä¸ä¼˜åŒ– - ä»å•æœºåˆ°ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´éƒ¨ç½²

> **ç‰ˆæœ¬ä¿¡æ¯**
> - **Docker**: 24.0+
> - **Python**: 3.12
> - **uv**: 0.5+
> - **ç¼–å†™æ—¥æœŸ**: 2025-01-16
> - **ä½œè€…**: LangGraph-RAG Tutorial Team

---

## æœ¬ç« å¯¼è¯»

æ­å–œï¼ç»è¿‡å‰é¢7ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„é‡‘èæ™ºèƒ½å®¢æœç³»ç»Ÿï¼š
- âœ… ç¬¬03ç« ï¼šé¡¹ç›®åˆå§‹åŒ–ä¸ç¯å¢ƒæ­å»º
- âœ… ç¬¬04ç« ï¼šå‘é‡æ•°æ®åº“æ„å»ºï¼ˆChromaDBï¼‰
- âœ… ç¬¬05ç« ï¼šæ ¸å¿ƒå·¥å…·å¼€å‘ï¼ˆRAG Toolï¼‰
- âœ… ç¬¬06ç« ï¼šRAG å·¥ä½œæµå®ç°ï¼ˆLangGraph Agentï¼‰
- âœ… ç¬¬07ç« ï¼šStreamlit Web ç•Œé¢å¼€å‘

ç°åœ¨ï¼Œæ˜¯æ—¶å€™å°†ç³»ç»Ÿæ¨å‘ç”Ÿäº§ç¯å¢ƒäº†ã€‚æœ¬ç« å°†è¦†ç›–**å®Œæ•´çš„éƒ¨ç½²æµç¨‹ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨åŠ å›º**ç­‰ç”Ÿäº§çº§æœ€ä½³å®è·µã€‚

**æœ¬ç« æ ¸å¿ƒé—®é¢˜ï¼š**
- ğŸ³ å¦‚ä½•å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDockerï¼‰ï¼Ÿ
- ğŸš€ å¦‚ä½•éƒ¨ç½²åˆ°äº‘ç«¯ï¼ˆé˜¿é‡Œäº‘ã€AWSã€æœ¬åœ°æœåŠ¡å™¨ï¼‰ï¼Ÿ
- ğŸ“Š å¦‚ä½•ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Ÿ
- ğŸ”’ å¦‚ä½•ä¿éšœå®‰å…¨æ€§ï¼ˆHTTPSã€èº«ä»½è®¤è¯ï¼‰ï¼Ÿ
- âš¡ å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼ˆç¼“å­˜ã€å¹¶å‘ã€é™æµï¼‰ï¼Ÿ
- ğŸ› ï¸ å¦‚ä½•è¿›è¡Œæ•…éšœæ’æŸ¥ä¸æ—¥å¿—ç®¡ç†ï¼Ÿ

**æœ¬ç« å°†å¸¦ä½ å®ç°ï¼š**
- âœ… Docker å®¹å™¨åŒ–å®Œæ•´æ–¹æ¡ˆ
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é…ç½®
- âœ… æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥
- âœ… å®‰å…¨åŠ å›ºä¸èº«ä»½è®¤è¯
- âœ… ç›‘æ§ä¸æ—¥å¿—ç³»ç»Ÿ
- âœ… æ•…éšœæ’æŸ¥æœ€ä½³å®è·µ

**æŠ€æœ¯æ ˆå¿«é€Ÿé¢„è§ˆï¼š**

```
ğŸ“¦ æœ¬ç« æŠ€æœ¯æ ˆ
â”œâ”€â”€ ğŸ³ å®¹å™¨åŒ–ï¼šDocker + Docker Compose
â”œâ”€â”€ ğŸš€ éƒ¨ç½²ï¼šäº‘æœåŠ¡å™¨ï¼ˆé˜¿é‡Œäº‘/AWSï¼‰
â”œâ”€â”€ ğŸ”’ å®‰å…¨ï¼šHTTPSï¼ˆLet's Encryptï¼‰+ èº«ä»½è®¤è¯
â”œâ”€â”€ ğŸ“Š ç›‘æ§ï¼šæ—¥å¿—æ”¶é›† + æ€§èƒ½æŒ‡æ ‡
â”œâ”€â”€ âš¡ ä¼˜åŒ–ï¼šç¼“å­˜ï¼ˆRedisï¼‰+ è´Ÿè½½å‡è¡¡
â””â”€â”€ ğŸ› ï¸ è¿ç»´ï¼šå¤‡ä»½æ¢å¤ + æ•…éšœæ’æŸ¥
```

---

## 1. Docker å®¹å™¨åŒ–éƒ¨ç½²

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ Dockerï¼Ÿ

#### **ä¼ ç»Ÿéƒ¨ç½² vs Docker éƒ¨ç½²**

| æ–¹é¢ | ä¼ ç»Ÿéƒ¨ç½² | Docker éƒ¨ç½² |
|------|----------|-------------|
| **ç¯å¢ƒä¸€è‡´æ€§** | âŒ "åœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘" | âœ… **å¼€å‘=ç”Ÿäº§ç¯å¢ƒ** |
| **éƒ¨ç½²é€Ÿåº¦** | âš ï¸ æ‰‹åŠ¨å®‰è£…ä¾èµ–ï¼ˆ10-30åˆ†é’Ÿï¼‰ | âœ… **ä¸€é”®å¯åŠ¨ï¼ˆ1-2åˆ†é’Ÿï¼‰** |
| **èµ„æºéš”ç¦»** | âŒ å…±äº«ç³»ç»Ÿèµ„æºï¼Œæ˜“å†²çª | âœ… **å®¹å™¨éš”ç¦»** |
| **ç‰ˆæœ¬ç®¡ç†** | âš ï¸ æ‰‹åŠ¨ç®¡ç† Python/ä¾èµ–ç‰ˆæœ¬ | âœ… **é•œåƒç‰ˆæœ¬åŒ–** |
| **å›æ»š** | âŒ å›°éš¾ï¼ˆéœ€é‡æ–°å®‰è£…ï¼‰ | âœ… **ä¸€é”®å›æ»š** |
| **æ‰©å±•æ€§** | âš ï¸ éœ€æ‰‹åŠ¨é…ç½®å¤šå°æœåŠ¡å™¨ | âœ… **å®¹å™¨ç¼–æ’ï¼ˆK8sï¼‰** |

---

### 1.2 Dockerfile å®Œæ•´å®ç°

åˆ›å»º `Dockerfile`ï¼š

```dockerfile
# ç¬¬1æ­¥ï¼šé€‰æ‹©åŸºç¡€é•œåƒï¼ˆä½¿ç”¨ uv å®˜æ–¹é•œåƒï¼‰
FROM ghcr.io/astral-sh/uv:python3.12-alpine

# ç¬¬2æ­¥ï¼šè®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ç¬¬3æ­¥ï¼šå¤åˆ¶é¡¹ç›®æ–‡ä»¶
# ä¼˜åŒ–ï¼šå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåˆ©ç”¨ Docker ç¼“å­˜å±‚
COPY pyproject.toml .
COPY .python-version .

# ç¬¬4æ­¥ï¼šå®‰è£…ä¾èµ–ï¼ˆæ— éœ€è™šæ‹Ÿç¯å¢ƒï¼‰
# --frozen: ä½¿ç”¨ uv.lock é”å®šç‰ˆæœ¬
# --no-dev: ä¸å®‰è£…å¼€å‘ä¾èµ–
RUN uv sync --frozen --no-dev

# ç¬¬5æ­¥ï¼šå¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# ç¬¬6æ­¥ï¼šåˆ›å»ºçŸ¥è¯†åº“ç›®å½•
RUN mkdir -p /app/kb

# ç¬¬7æ­¥ï¼šæš´éœ²ç«¯å£
EXPOSE 8501

# ç¬¬8æ­¥ï¼šå¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8501/_stcore/health || exit 1

# ç¬¬9æ­¥ï¼šå¯åŠ¨å‘½ä»¤
CMD ["uv", "run", "streamlit", "run", "rag.py", \
     "--server.port=8501", \
     "--server.address=0.0.0.0", \
     "--server.headless=true", \
     "--browser.gatherUsageStats=false"]
```

---

### 1.3 Dockerfile ä¼˜åŒ–æŠ€å·§

#### **1. åˆ©ç”¨ Docker ç¼“å­˜å±‚**

```dockerfile
# âŒ é”™è¯¯æ–¹å¼ï¼šæ¯æ¬¡ä»£ç æ”¹åŠ¨éƒ½é‡æ–°å®‰è£…ä¾èµ–
COPY . .
RUN uv sync

# âœ… æ­£ç¡®æ–¹å¼ï¼šå…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼Œåå¤åˆ¶ä»£ç 
COPY pyproject.toml .
RUN uv sync         # åªæœ‰ä¾èµ–å˜åŒ–æ—¶æ‰é‡æ–°æ‰§è¡Œ
COPY . .            # ä»£ç å˜åŒ–ä¸å½±å“ä¾èµ–å®‰è£…
```

**æ•ˆæœå¯¹æ¯”ï¼š**
- é”™è¯¯æ–¹å¼ï¼šä»£ç æ”¹åŠ¨ â†’ é‡æ–°æ„å»º â†’ **3åˆ†é’Ÿ**
- æ­£ç¡®æ–¹å¼ï¼šä»£ç æ”¹åŠ¨ â†’ é‡æ–°æ„å»º â†’ **10ç§’**ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰

---

#### **2. ä½¿ç”¨ alpine åŸºç¡€é•œåƒ**

```dockerfile
# é•œåƒå¤§å°å¯¹æ¯”
FROM python:3.12              # 1.2 GB
FROM python:3.12-slim         # 400 MB
FROM python:3.12-alpine       # 150 MB âœ…ï¼ˆæ¨èï¼‰
```

**trade-offï¼š**
- âœ… **alpine ä¼˜åŠ¿**ï¼šä½“ç§¯å°ã€å¯åŠ¨å¿«ã€å®‰å…¨æ€§é«˜
- âš ï¸ **alpine åŠ£åŠ¿**ï¼šéƒ¨åˆ†åŒ…éœ€è¦ç¼–è¯‘ï¼ˆå¦‚ numpyï¼‰ï¼Œå¯èƒ½æ„å»ºæ…¢

**è§£å†³æ–¹æ¡ˆï¼š**
```dockerfile
# å¦‚æœé‡åˆ°ç¼–è¯‘é—®é¢˜ï¼Œå¯ä¸´æ—¶ä½¿ç”¨ slim
FROM python:3.12-slim
# æˆ–å®‰è£…ç¼–è¯‘ä¾èµ–
RUN apk add --no-cache gcc musl-dev
```

---

#### **3. å¤šé˜¶æ®µæ„å»ºï¼ˆé«˜çº§ï¼‰**

```dockerfile
# ç¬¬1é˜¶æ®µï¼šæ„å»ºç¯å¢ƒ
FROM ghcr.io/astral-sh/uv:python3.12 AS builder
WORKDIR /app
COPY pyproject.toml .
RUN uv sync --frozen --no-dev

# ç¬¬2é˜¶æ®µï¼šè¿è¡Œç¯å¢ƒï¼ˆæ›´å°ï¼‰
FROM python:3.12-alpine
WORKDIR /app

# åªå¤åˆ¶å¿…è¦çš„æ–‡ä»¶
COPY --from=builder /app/.venv /app/.venv
COPY . .

CMD [".venv/bin/streamlit", "run", "rag.py"]
```

**æ•ˆæœï¼š**é•œåƒå¤§å°å‡å°‘ **40%**

---

### 1.4 .dockerignore é…ç½®

åˆ›å»º `.dockerignore`ï¼ˆç±»ä¼¼ `.gitignore`ï¼‰ï¼š

```gitignore
# Python
__pycache__/
*.py[cod]
.pytest_cache/

# è™šæ‹Ÿç¯å¢ƒï¼ˆå®¹å™¨å†…ä¼šé‡æ–°åˆ›å»ºï¼‰
.venv/
venv/

# å¼€å‘æ–‡ä»¶
.git/
.gitignore
README.md
docs/

# çŸ¥è¯†åº“æ•°æ®ï¼ˆè¿è¡Œæ—¶æŒ‚è½½ï¼‰
kb/

# IDE
.vscode/
.idea/

# ç¯å¢ƒå˜é‡ï¼ˆé€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥ï¼‰
.env
.env.local

# æ—¥å¿—
*.log
```

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**
- âœ… å‡å°‘é•œåƒå¤§å°ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
- âœ… åŠ å¿«æ„å»ºé€Ÿåº¦ï¼ˆå‡å°‘ COPY æ—¶é—´ï¼‰
- âœ… å®‰å…¨æ€§ï¼ˆä¸åŒ…å«æ•æ„Ÿæ–‡ä»¶ï¼‰

---

### 1.5 æ„å»ºä¸è¿è¡Œ

#### **æ„å»ºé•œåƒ**

```bash
# åŸºç¡€æ„å»º
docker build -t langgraph-rag:latest .

# æŒ‡å®šå¹³å°ï¼ˆè·¨å¹³å°æ„å»ºï¼‰
docker build --platform linux/amd64 -t langgraph-rag:latest .

# å¸¦ç¼“å­˜æ§åˆ¶
docker build --no-cache -t langgraph-rag:latest .
```

---

#### **è¿è¡Œå®¹å™¨**

```bash
# åŸºç¡€è¿è¡Œ
docker run -p 8501:8501 langgraph-rag:latest

# å®Œæ•´å‚æ•°
docker run -d \
  --name langgraph-rag-app \
  -p 8501:8501 \
  -e OPENAI_API_KEY="sk-xxx" \
  -e OPENAI_MODEL="gpt-4o-mini" \
  -v $(pwd)/kb:/app/kb \
  --restart unless-stopped \
  langgraph-rag:latest

# å‚æ•°è¯´æ˜ï¼š
# -d: åå°è¿è¡Œ
# --name: å®¹å™¨åç§°
# -p: ç«¯å£æ˜ å°„ï¼ˆä¸»æœº:å®¹å™¨ï¼‰
# -e: ç¯å¢ƒå˜é‡
# -v: æŒ‚è½½å·ï¼ˆçŸ¥è¯†åº“æŒä¹…åŒ–ï¼‰
# --restart: è‡ªåŠ¨é‡å¯ç­–ç•¥
```

---

#### **æŸ¥çœ‹æ—¥å¿—**

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker logs -f langgraph-rag-app

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker logs --tail 100 langgraph-rag-app

# æŸ¥çœ‹æŒ‡å®šæ—¶é—´æ®µ
docker logs --since "2025-01-16T10:00:00" langgraph-rag-app
```

---

## 2. Docker Compose å¤šå®¹å™¨ç¼–æ’

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ Docker Composeï¼Ÿ

**å•å®¹å™¨ vs å¤šå®¹å™¨ï¼š**

```
å•å®¹å™¨æ¶æ„ï¼ˆå½“å‰ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Streamlit + Agent      â”‚
â”‚   + ChromaDBï¼ˆåµŒå…¥å¼ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤šå®¹å™¨æ¶æ„ï¼ˆç”Ÿäº§æ¨èï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Streamlit   â”‚â†â†’â”‚     Agent    â”‚â†â†’â”‚   ChromaDB   â”‚
â”‚   (Web UI)   â”‚  â”‚  (RAG é€»è¾‘)  â”‚  â”‚  (å‘é‡æ•°æ®åº“) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Redis     â”‚
â”‚   (ç¼“å­˜å±‚)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.2 docker-compose.yml å®Œæ•´é…ç½®

åˆ›å»º `docker-compose.yml`ï¼š

```yaml
version: '3.8'

services:
  # æœåŠ¡1ï¼šStreamlit åº”ç”¨
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: langgraph-rag-app
    ports:
      - "8501:8501"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL}
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./kb:/app/kb                    # çŸ¥è¯†åº“æŒä¹…åŒ–
      - ./logs:/app/logs                # æ—¥å¿—æŒä¹…åŒ–
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - langgraph-network

  # æœåŠ¡2ï¼šRedis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: langgraph-rag-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes  # æŒä¹…åŒ–
    restart: unless-stopped
    networks:
      - langgraph-network

  # æœåŠ¡3ï¼šNginx åå‘ä»£ç†ï¼ˆå¯é€‰ï¼‰
  nginx:
    image: nginx:alpine
    container_name: langgraph-rag-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro          # SSL è¯ä¹¦
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - langgraph-network

volumes:
  redis-data:

networks:
  langgraph-network:
    driver: bridge
```

---

### 2.3 å¯åŠ¨ä¸ç®¡ç†

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f app

# é‡å¯æœåŠ¡
docker-compose restart app

# åœæ­¢æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

---

## 3. æ€§èƒ½ä¼˜åŒ–

### 3.1 ç¼“å­˜ç­–ç•¥

#### **Embeddings ç¼“å­˜**

**é—®é¢˜ï¼š**é‡å¤å‘é‡åŒ–æµªè´¹æˆæœ¬

```python
# æ— ç¼“å­˜ï¼šæ¯æ¬¡éƒ½è°ƒç”¨ OpenAI API
vectorstore = Chroma.from_documents(
    documents=chunks,
    embedding=OpenAIEmbeddings()  # æ¯æ¬¡è°ƒç”¨ API
)

# æˆæœ¬ï¼š1000ä¸ªæ–‡æ¡£ Ã— $0.00002/1K tokens = $0.02ï¼ˆæ¯æ¬¡ï¼‰
# å¦‚æœé‡å¤10æ¬¡ = $0.20
```

**è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Redis ç¼“å­˜**

```python
from langchain.embeddings import CacheBackedEmbeddings
from langchain.storage import RedisStore
import redis

# è¿æ¥ Redis
redis_client = redis.Redis.from_url("redis://localhost:6379")
store = RedisStore(redis_client=redis_client)

# åŒ…è£… Embeddings
cached_embeddings = CacheBackedEmbeddings.from_bytes_store(
    underlying_embeddings=OpenAIEmbeddings(),
    document_embedding_cache=store,
    namespace="openai_embeddings"
)

# ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬
vectorstore = Chroma.from_documents(
    documents=chunks,
    embedding=cached_embeddings  # é¦–æ¬¡è°ƒç”¨ APIï¼Œåç»­ä»ç¼“å­˜è¯»å–
)

# æ•ˆæœï¼š
# ç¬¬1æ¬¡ï¼šè°ƒç”¨ APIï¼ˆ$0.02ï¼‰
# ç¬¬2æ¬¡åŠä»¥åï¼šä»ç¼“å­˜è¯»å–ï¼ˆ$0ï¼‰
```

---

#### **LLM å“åº”ç¼“å­˜**

```python
from langchain.cache import RedisCache
from langchain.globals import set_llm_cache

# è®¾ç½®å…¨å±€ç¼“å­˜
set_llm_cache(RedisCache(redis_url="redis://localhost:6379"))

# ä½¿ç”¨
llm = ChatOpenAI(model="gpt-4o-mini")

# ç¬¬1æ¬¡è°ƒç”¨
response1 = llm.invoke("æˆ¿è´·åˆ©ç‡æ˜¯å¤šå°‘ï¼Ÿ")  # è°ƒç”¨ API

# ç¬¬2æ¬¡ç›¸åŒæŸ¥è¯¢
response2 = llm.invoke("æˆ¿è´·åˆ©ç‡æ˜¯å¤šå°‘ï¼Ÿ")  # ä»ç¼“å­˜è¯»å–ï¼ˆæå¿«ï¼‰
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- âœ… é€‚ç”¨åœºæ™¯ï¼šFAQã€å¸¸è§é—®é¢˜
- âš ï¸ æ³¨æ„ï¼šéœ€å®šæœŸæ¸…ç†ç¼“å­˜ï¼ˆé¿å…è¿‡æœŸä¿¡æ¯ï¼‰

---

### 3.2 å¹¶å‘å¤„ç†

#### **Streamlit å¹¶å‘é™åˆ¶**

é»˜è®¤æƒ…å†µä¸‹ï¼ŒStreamlit æ˜¯å•çº¿ç¨‹çš„ï¼ŒåŒæ—¶åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚

**è§£å†³æ–¹æ¡ˆï¼šå¤šå‰¯æœ¬éƒ¨ç½²**

```yaml
# docker-compose.yml
services:
  app:
    build: .
    deploy:
      replicas: 3  # å¯åŠ¨3ä¸ªå‰¯æœ¬
    # ...

  nginx:
    image: nginx:alpine
    # è´Ÿè½½å‡è¡¡é…ç½®
```

**Nginx è´Ÿè½½å‡è¡¡é…ç½®ï¼š**

```nginx
# nginx.conf
http {
    upstream streamlit_backend {
        server app:8501;
        server app:8502;
        server app:8503;
    }

    server {
        listen 80;

        location / {
            proxy_pass http://streamlit_backend;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

---

### 3.3 æ•°æ®åº“ä¼˜åŒ–

#### **ChromaDB æ€§èƒ½ä¼˜åŒ–**

```python
# ä¼˜åŒ–1ï¼šæ‰¹é‡æ·»åŠ æ–‡æ¡£
# âŒ é€ä¸ªæ·»åŠ ï¼ˆæ…¢ï¼‰
for chunk in chunks:
    vectorstore.add_documents([chunk])

# âœ… æ‰¹é‡æ·»åŠ ï¼ˆå¿« 10xï¼‰
vectorstore.add_documents(chunks)

# ä¼˜åŒ–2ï¼šé™åˆ¶æ£€ç´¢æ•°é‡
retriever = vectorstore.as_retriever(
    search_kwargs={"k": 3}  # åªè¿”å› 3 ä¸ªï¼ˆè€Œéé»˜è®¤ 4 ä¸ªï¼‰
)

# ä¼˜åŒ–3ï¼šä½¿ç”¨ MMRï¼ˆå‡å°‘å†—ä½™ï¼‰
retriever = vectorstore.as_retriever(
    search_type="mmr",
    search_kwargs={"k": 3, "fetch_k": 10}
)
```

---

## 4. å®‰å…¨åŠ å›º

### 4.1 HTTPS é…ç½®

#### **ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦**

```bash
# ç¬¬1æ­¥ï¼šå®‰è£… Certbot
sudo apt-get install certbot python3-certbot-nginx

# ç¬¬2æ­¥ï¼šè·å–è¯ä¹¦
sudo certbot --nginx -d yourdomain.com

# ç¬¬3æ­¥ï¼šè‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

#### **Nginx HTTPS é…ç½®**

```nginx
# nginx.conf
server {
    listen 80;
    server_name yourdomain.com;

    # HTTP é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    # SSL è¯ä¹¦
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://app:8501;
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

### 4.2 èº«ä»½è®¤è¯

#### **æ–¹å¼1ï¼šStreamlit åŸç”Ÿè®¤è¯ï¼ˆç®€å•ï¼‰**

åœ¨ `.streamlit/config.toml` ä¸­ï¼š

```toml
[server]
enableCORS = false

[client]
showErrorDetails = false

# ç®€å•å¯†ç ä¿æŠ¤
[server]
enableStaticServing = true
```

ç„¶ååœ¨ä»£ç ä¸­ï¼š

```python
import streamlit as st
import hashlib

def check_password():
    """ç®€å•å¯†ç éªŒè¯"""
    def password_entered():
        if hashlib.sha256(st.session_state["password"].encode()).hexdigest() == \
           "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8":  # "password"
            st.session_state["password_correct"] = True
            del st.session_state["password"]
        else:
            st.session_state["password_correct"] = False

    if "password_correct" not in st.session_state:
        st.text_input("è¯·è¾“å…¥å¯†ç ", type="password", on_change=password_entered, key="password")
        return False
    elif not st.session_state["password_correct"]:
        st.text_input("è¯·è¾“å…¥å¯†ç ", type="password", on_change=password_entered, key="password")
        st.error("ğŸ˜• å¯†ç é”™è¯¯")
        return False
    else:
        return True

if not check_password():
    st.stop()

# ä¸»åº”ç”¨ä»£ç 
st.write("æ¬¢è¿æ¥åˆ°é‡‘èæ™ºèƒ½å®¢æœç³»ç»Ÿ")
```

---

#### **æ–¹å¼2ï¼šNginx åŸºæœ¬è®¤è¯ï¼ˆæ¨èï¼‰**

```bash
# åˆ›å»ºå¯†ç æ–‡ä»¶
sudo htpasswd -c /etc/nginx/.htpasswd admin

# Nginx é…ç½®
server {
    listen 443 ssl;

    location / {
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        proxy_pass http://app:8501;
    }
}
```

---

### 4.3 API å¯†é’¥ä¿æŠ¤

```python
# âŒ é”™è¯¯ï¼šå¯†é’¥ç¡¬ç¼–ç 
api_key = "sk-1234567890abcdef"

# âœ… æ­£ç¡®ï¼šç¯å¢ƒå˜é‡
import os
api_key = os.getenv("OPENAI_API_KEY")
if not api_key:
    raise ValueError("è¯·è®¾ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡")

# âœ… æ›´å¥½ï¼šå¯†é’¥ç®¡ç†æœåŠ¡
# AWS Secrets Manager / Azure Key Vault / HashiCorp Vault
```

---

## 5. ç›‘æ§ä¸æ—¥å¿—

### 5.1 åº”ç”¨æ—¥å¿—

#### **é…ç½®æ—¥å¿—ç³»ç»Ÿ**

åˆ›å»º `app_utils/logger.py`ï¼š

```python
import logging
import sys
from pathlib import Path

def setup_logger(name: str = "langgraph-rag", level: int = logging.INFO):
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    log_dir = Path("logs")
    log_dir.mkdir(exist_ok=True)

    # åˆ›å»º logger
    logger = logging.getLogger(name)
    logger.setLevel(level)

    # æ ¼å¼åŒ–
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )

    # æ–‡ä»¶å¤„ç†å™¨
    file_handler = logging.FileHandler(log_dir / "app.log")
    file_handler.setFormatter(formatter)
    logger.addHandler(file_handler)

    # æ§åˆ¶å°å¤„ç†å™¨
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)

    return logger

# ä½¿ç”¨
logger = setup_logger()
logger.info("åº”ç”¨å¯åŠ¨")
logger.error("å‘ç”Ÿé”™è¯¯", exc_info=True)
```

---

#### **åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—**

```python
from app_utils.logger import setup_logger

logger = setup_logger()

def get_rag_chat_response(user_input):
    logger.info(f"ç”¨æˆ·è¾“å…¥: {user_input}")

    try:
        response = agent.invoke({"messages": [...]})
        logger.info(f"AI å›å¤: {response['messages'][-1].content[:100]}...")
        return response

    except Exception as e:
        logger.error(f"å¤„ç†è¯·æ±‚å¤±è´¥: {str(e)}", exc_info=True)
        raise
```

---

### 5.2 æ€§èƒ½ç›‘æ§

#### **è®°å½•å“åº”æ—¶é—´**

```python
import time
from functools import wraps

def monitor_performance(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start_time = time.time()
        try:
            result = func(*args, **kwargs)
            elapsed = time.time() - start_time
            logger.info(f"{func.__name__} æ‰§è¡Œæ—¶é—´: {elapsed:.2f}s")
            return result
        except Exception as e:
            elapsed = time.time() - start_time
            logger.error(f"{func.__name__} æ‰§è¡Œå¤±è´¥ ({elapsed:.2f}s): {str(e)}")
            raise
    return wrapper

# ä½¿ç”¨
@monitor_performance
def get_rag_chat_response(user_input):
    return agent.invoke({"messages": [...]})
```

---

## 6. ç”Ÿäº§éƒ¨ç½²æ¸…å•

### 6.1 éƒ¨ç½²å‰æ£€æŸ¥

```bash
# 1. ç¯å¢ƒå˜é‡æ£€æŸ¥
cat .env
# ç¡®ä¿åŒ…å«ï¼šOPENAI_API_KEY, OPENAI_MODEL

# 2. ä¾èµ–æ£€æŸ¥
uv sync --frozen

# 3. æµ‹è¯•è¿è¡Œ
uv run streamlit run rag.py

# 4. Docker æ„å»ºæµ‹è¯•
docker build -t langgraph-rag:test .
docker run -p 8501:8501 langgraph-rag:test

# 5. çŸ¥è¯†åº“å‡†å¤‡
ls kb/
# ç¡®ä¿çŸ¥è¯†åº“æ–‡ä»¶å·²ä¸Šä¼ 

# 6. æ€§èƒ½æµ‹è¯•
# ä½¿ç”¨ Apache Bench æˆ– Locust
```

---

### 6.2 äº‘ç«¯éƒ¨ç½²ï¼ˆé˜¿é‡Œäº‘ç¤ºä¾‹ï¼‰

```bash
# ç¬¬1æ­¥ï¼šè´­ä¹°äº‘æœåŠ¡å™¨ï¼ˆECSï¼‰
# é…ç½®ï¼š2æ ¸4GBï¼ŒUbuntu 22.04

# ç¬¬2æ­¥ï¼šå®‰è£… Docker
ssh root@your-server-ip
curl -fsSL https://get.docker.com | sh
sudo systemctl start docker

# ç¬¬3æ­¥ï¼šä¸Šä¼ ä»£ç 
scp -r langgraph-rag root@your-server-ip:/opt/

# ç¬¬4æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡
cd /opt/langgraph-rag
nano .env
# å¡«å…¥ OPENAI_API_KEY ç­‰

# ç¬¬5æ­¥ï¼šå¯åŠ¨æœåŠ¡
docker-compose up -d

# ç¬¬6æ­¥ï¼šé…ç½®åŸŸåè§£æ
# é˜¿é‡Œäº‘æ§åˆ¶å° â†’ åŸŸå â†’ æ·»åŠ  A è®°å½•
# yourdomain.com â†’ your-server-ip

# ç¬¬7æ­¥ï¼šé…ç½® HTTPS
sudo certbot --nginx -d yourdomain.com
```

---

## 7. æ•…éšœæ’æŸ¥

### 7.1 å¸¸è§é—®é¢˜

#### **é—®é¢˜1ï¼šå®¹å™¨æ— æ³•å¯åŠ¨**

```bash
# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker logs langgraph-rag-app

# å¸¸è§åŸå› ï¼š
# 1. ç«¯å£è¢«å ç”¨
lsof -i :8501  # æŸ¥çœ‹å ç”¨ç«¯å£çš„è¿›ç¨‹
kill -9 <PID>  # æ€æ­»è¿›ç¨‹

# 2. ç¯å¢ƒå˜é‡æœªè®¾ç½®
docker exec -it langgraph-rag-app env | grep OPENAI
```

---

#### **é—®é¢˜2ï¼šçŸ¥è¯†åº“æ£€ç´¢å¤±è´¥**

```bash
# æ£€æŸ¥æŒ‚è½½æ˜¯å¦æˆåŠŸ
docker exec -it langgraph-rag-app ls /app/kb

# æ£€æŸ¥æƒé™
docker exec -it langgraph-rag-app ls -la /app/kb
```

---

#### **é—®é¢˜3ï¼šæ€§èƒ½ç“¶é¢ˆ**

```bash
# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats langgraph-rag-app

# å¢åŠ å†…å­˜é™åˆ¶
docker run -m 4g langgraph-rag:latest
```

---

## 8. æœ¬ç« æ€»ç»“

### 8.1 æœ¬ç« æ”¶è·

é€šè¿‡æœ¬ç« å­¦ä¹ ï¼Œæˆ‘ä»¬å®Œæˆäº†ï¼š

âœ… **Docker å®¹å™¨åŒ–**
- Dockerfile ä¼˜åŒ–ï¼ˆç¼“å­˜å±‚ã€alpine é•œåƒï¼‰
- docker-compose å¤šå®¹å™¨ç¼–æ’
- é•œåƒæ„å»ºä¸è¿è¡Œ

âœ… **æ€§èƒ½ä¼˜åŒ–**
- Embeddings ç¼“å­˜ï¼ˆRedisï¼‰
- å¹¶å‘å¤„ç†ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- æ•°æ®åº“ä¼˜åŒ–ï¼ˆæ‰¹é‡æ“ä½œï¼‰

âœ… **å®‰å…¨åŠ å›º**
- HTTPS é…ç½®ï¼ˆLet's Encryptï¼‰
- èº«ä»½è®¤è¯ï¼ˆNginx åŸºæœ¬è®¤è¯ï¼‰
- API å¯†é’¥ä¿æŠ¤

âœ… **ç›‘æ§ä¸æ—¥å¿—**
- æ—¥å¿—ç³»ç»Ÿé…ç½®
- æ€§èƒ½ç›‘æ§è£…é¥°å™¨
- æ•…éšœæ’æŸ¥æµç¨‹

âœ… **ç”Ÿäº§éƒ¨ç½²**
- äº‘ç«¯éƒ¨ç½²æµç¨‹ï¼ˆé˜¿é‡Œäº‘ï¼‰
- éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
- å¸¸è§é—®é¢˜æ’æŸ¥

---

### 8.2 å®Œæ•´æŠ€æœ¯æ ˆå›é¡¾

**ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€ç¯‡ï¼ˆç¬¬01-02ç« ï¼‰**
- LangChain 1.x æ¡†æ¶å‡çº§
- LangGraph 1.x å·¥ä½œæµç¼–æ’

**ç¬¬äºŒéƒ¨åˆ†ï¼šå®æˆ˜ç¯‡ï¼ˆç¬¬03-08ç« ï¼‰**
- ç¬¬03ç« ï¼šuv é¡¹ç›®åˆå§‹åŒ–
- ç¬¬04ç« ï¼šChromaDB å‘é‡æ•°æ®åº“
- ç¬¬05ç« ï¼šStructuredTool å·¥å…·å¼€å‘
- ç¬¬06ç« ï¼šLangGraph ReAct Agent
- ç¬¬07ç« ï¼šStreamlit Web ç•Œé¢
- ç¬¬08ç« ï¼šDocker ç”Ÿäº§éƒ¨ç½²

**æ ¸å¿ƒæŠ€æœ¯æ ˆï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Python 3.12 + uv åŒ…ç®¡ç†å™¨          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  LangChain 1.x + LangGraph 1.x      â”‚
â”‚  ChromaDB å‘é‡æ•°æ®åº“                â”‚
â”‚  OpenAI Embeddings + GPT-4o-mini    â”‚
â”‚  Streamlit Web æ¡†æ¶                 â”‚
â”‚  Docker + Docker Compose            â”‚
â”‚  Nginx + Let's Encrypt (HTTPS)      â”‚
â”‚  Redis ç¼“å­˜                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8.3 ä¸‹ä¸€æ­¥å»ºè®®

**ç»§ç»­æ·±å…¥å­¦ä¹ ï¼š**

1. **LangGraph è¿›é˜¶**
   - å­å›¾ï¼ˆSubgraphï¼‰
   - æ¡ä»¶å¾ªç¯ï¼ˆConditional Loopsï¼‰
   - äººç±»åé¦ˆï¼ˆHuman-in-the-Loopï¼‰

2. **RAG ä¼˜åŒ–**
   - æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰
   - é‡æ’åºï¼ˆRerankingï¼‰
   - æŸ¥è¯¢æ”¹å†™ï¼ˆQuery Rewritingï¼‰

3. **ç”Ÿäº§ä¼˜åŒ–**
   - Kubernetes å®¹å™¨ç¼–æ’
   - Prometheus + Grafana ç›‘æ§
   - ELK æ—¥å¿—èšåˆ

---

## å®Œç»“æ„Ÿè¨€

æ­å–œä½ å®Œæˆäº†ã€ŠLangGraph+RAG é‡‘èæ™ºèƒ½å®¢æœç³»ç»Ÿã€‹å®Œæ•´æ•™ç¨‹ï¼

ä»é¡¹ç›®åˆå§‹åŒ–åˆ°ç”Ÿäº§éƒ¨ç½²ï¼Œä½ å·²ç»æŒæ¡äº†æ„å»ºä¼ä¸šçº§ RAG åº”ç”¨çš„å…¨éƒ¨æŠ€èƒ½ã€‚è¿™å¥—ç³»ç»Ÿä¸ä»…é€‚ç”¨äºé‡‘èå®¢æœï¼Œç¨ä½œè°ƒæ•´å³å¯åº”ç”¨äºï¼š
- ğŸ“š ä¼ä¸šçŸ¥è¯†åº“é—®ç­”
- ğŸ¥ åŒ»ç–—å’¨è¯¢åŠ©æ‰‹
- ğŸ“– æ•™è‚²è¾…å¯¼ç³»ç»Ÿ
- ğŸ¢ å†…éƒ¨æ–‡æ¡£æ£€ç´¢

**è®°ä½æ ¸å¿ƒåŸåˆ™ï¼š**
- âœ… å§‹ç»ˆå°Šé‡ç°æœ‰ä»£ç ï¼ˆä¸ä¼˜åŒ–ã€ä¸ç®€åŒ–ï¼‰
- âœ… æ³¨é‡å·¥ç¨‹å®è·µï¼ˆDockerã€æ—¥å¿—ã€ç›‘æ§ï¼‰
- âœ… å…³æ³¨ç”¨æˆ·ä½“éªŒï¼ˆæµå¼è¾“å‡ºã€é”™è¯¯æç¤ºï¼‰
- âœ… æŒç»­å­¦ä¹ è¿­ä»£ï¼ˆæŠ€æœ¯æ ˆå¿«é€Ÿæ¼”è¿›ï¼‰

ç¥ä½ åœ¨ AI åº”ç”¨å¼€å‘çš„é“è·¯ä¸Šè¶Šèµ°è¶Šè¿œï¼ğŸš€

---

**ç‰ˆæœ¬ä¿¡æ¯**
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **æœ€åæ›´æ–°**: 2025-01-16
- **é€‚é…é¡¹ç›®ç‰ˆæœ¬**: langgraph-rag v0.1.0
- **ä½œè€…**: LangGraph-RAG Tutorial Team
- **å…¨ç³»åˆ—å®Œç»“**: 2025-01-16

**æ•™ç¨‹ç»Ÿè®¡ï¼š**
- æ€»ç« èŠ‚ï¼š8ç« ï¼ˆåŸºç¡€ç¯‡2ç«  + å®æˆ˜ç¯‡6ç« ï¼‰
- æ€»å­—æ•°ï¼šçº¦ 100,000å­—
- ä»£ç ç¤ºä¾‹ï¼š200+ä¸ª
- Mermaid å›¾è¡¨ï¼š15+ä¸ª
